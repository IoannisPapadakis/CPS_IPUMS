----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  main_06
       log:  /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_05/main_06.log
  log type:  text
 opened on:  13 Jan 2018, 16:40:08

. 
. use "Partners.dta", clear

. 
. ******************************************************************************************************************************
. **** This script compute the individual transtion rates conditional on the partner status. 
. ******************************************************************************************************************************
. 
. 
. ** Keep only the variable I need for this computation
. keep cpsid cpsidp year month sex empstat labforce tran marst cpsidp_sp empstat_sp labforce_sp wtfinl

. 
. 
. ** I keep only the married couples who live together
. keep if marst==1
(9,366,218 observations deleted)

. 
. 
. ** Drop if partner's emplyment status is missing
. drop if empstat_sp==.     // 605,696 deleted
(609,734 observations deleted)

. 
. 
. ** I drop invalid transitions
. drop if tran==0  // (.)
(3,929,722 observations deleted)

. 
. 
. ** I create a variable which contains the broad category of Employed, Unemployed, Not in the labor force. Careful! It refer to the previous observation in time! Hence is not consistent with empstat.
. gen empstat_broad = 0, before(tran)

. replace empstat_broad =1 if ( tran == 2 | tran == 3 | tran == 5 )
(5,983,811 real changes made)

. replace empstat_broad =2 if ( tran == 1 | tran == 6 | tran == 8 )
(219,761 real changes made)

. replace empstat_broad =3 if ( tran == 7 | tran == 9 | tran == 4 )
(1,641,960 real changes made)

. 
. * Define the value labels
. label define flows_1 1 "E" 2 "U" 3 "N" 

. label values empstat_broad flows_1

. 
. 
. ** Create broad categories of labor status for the partners
. gen empstat_sp_broad = 0

. replace empstat_sp_broad = 1 if ( empstat_sp == 01 | empstat_sp == 10 | empstat_sp == 12 )
(6,091,441 real changes made)

. replace empstat_sp_broad = 2 if ( empstat_sp == 21 | empstat_sp == 22 )
(204,817 real changes made)

. replace empstat_sp_broad = 3 if ( labforce_sp == 1 )
(1,549,274 real changes made)

. 
. * Define the value labels
. label define flows_2 1 "E" 2 "U" 3 "N" 

. label values empstat_sp_broad flows_2

. 
. 
. ** Keep, Sort, order the data
. keep cpsid cpsidp year month empstat_sp_broad empstat_broad tran wtfinl

. sort year month empstat_sp_broad empstat_broad

. order cpsid cpsidp year month empstat_sp_broad empstat_broad tran wtfinl

. 
. 
. ** Compute the rates, employed partner
. 
. ** E-->E
. generate EE_ind = tran == 3 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen EE_mr = wtmean(100 * EE_ind), weight(wtfinl)

. 
. ** E-->U 
. generate EU_ind = tran == 2 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen EU_mr = wtmean(100 * EU_ind), weight(wtfinl)

. 
. ** E-->N
. generate EN_ind = tran == 5 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen EN_mr = wtmean(100 * EN_ind), weight(wtfinl)

. 
. ** U-->E
. generate UE_ind = tran == 1 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen UE_mr = wtmean(100 * UE_ind), weight(wtfinl)

. 
. ** U-->U
. generate UU_ind = tran == 8 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen UU_mr = wtmean(100 * UU_ind), weight(wtfinl)

. 
. ** U-->N
. generate UN_ind = tran == 6 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen UN_mr = wtmean(100 * UN_ind), weight(wtfinl)

. 
. ** N-->E
. generate NE_ind = tran == 4 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen NE_mr = wtmean(100 * NE_ind), weight(wtfinl)

. 
. ** N-->U
. generate NU_ind = tran == 7 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen NU_mr = wtmean(100 * NU_ind), weight(wtfinl)

. 
. ** N-->N
. generate NN_ind = tran == 9 & empstat_sp_broad == 1

. by year month empstat_sp_broad empstat_broad: egen NN_mr = wtmean(100 * NN_ind), weight(wtfinl)

. 
. drop UE_ind EU_ind EE_ind NE_ind EN_ind UN_ind NU_ind UU_ind NN_ind

. 
. foreach x of varlist EE_mr EU_mr EN_mr UE_mr UU_mr UN_mr NE_mr NU_mr NN_mr {   // rename all of the variables as the "spouse variable"
  2.         rename `x' `x'_E
  3. }

. *
. 
. 
. ** Compute the rates, unemployed partner
. 
. ** E-->E
. generate EE_ind = tran == 3 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen EE_mr = wtmean(100 * EE_ind), weight(wtfinl)

. 
. ** E-->U 
. generate EU_ind = tran == 2 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen EU_mr = wtmean(100 * EU_ind), weight(wtfinl)

. 
. ** E-->N
. generate EN_ind = tran == 5 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen EN_mr = wtmean(100 * EN_ind), weight(wtfinl)

. 
. ** U-->E
. generate UE_ind = tran == 1 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen UE_mr = wtmean(100 * UE_ind), weight(wtfinl)

. 
. ** U-->U
. generate UU_ind = tran == 8 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen UU_mr = wtmean(100 * UU_ind), weight(wtfinl)

. 
. ** U-->N
. generate UN_ind = tran == 6 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen UN_mr = wtmean(100 * UN_ind), weight(wtfinl)

. 
. ** N-->E
. generate NE_ind = tran == 4 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen NE_mr = wtmean(100 * NE_ind), weight(wtfinl)

. 
. ** N-->U
. generate NU_ind = tran == 7 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen NU_mr = wtmean(100 * NU_ind), weight(wtfinl)

. 
. ** N-->N
. generate NN_ind = tran == 9 & empstat_sp_broad == 2

. by year month empstat_sp_broad empstat_broad: egen NN_mr = wtmean(100 * NN_ind), weight(wtfinl)

. 
. drop UE_ind EU_ind EE_ind NE_ind EN_ind UN_ind NU_ind UU_ind NN_ind

. 
. foreach x of varlist EE_mr EU_mr EN_mr UE_mr UU_mr UN_mr NE_mr NU_mr NN_mr {   // rename all of the variables as the "spouse variable"
  2.         rename `x' `x'_U
  3. }

. *
. 
. 
. ** Compute the rates, nilf partner
. 
. ** E-->E
. generate EE_ind = tran == 3 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen EE_mr = wtmean(100 * EE_ind), weight(wtfinl)

. 
. ** E-->U 
. generate EU_ind = tran == 2 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen EU_mr = wtmean(100 * EU_ind), weight(wtfinl)

. 
. ** E-->N
. generate EN_ind = tran == 5 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen EN_mr = wtmean(100 * EN_ind), weight(wtfinl)

. 
. ** U-->E
. generate UE_ind = tran == 1 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen UE_mr = wtmean(100 * UE_ind), weight(wtfinl)

. 
. ** U-->U
. generate UU_ind = tran == 8 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen UU_mr = wtmean(100 * UU_ind), weight(wtfinl)

. 
. ** U-->N
. generate UN_ind = tran == 6 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen UN_mr = wtmean(100 * UN_ind), weight(wtfinl)

. 
. ** N-->E
. generate NE_ind = tran == 4 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen NE_mr = wtmean(100 * NE_ind), weight(wtfinl)

. 
. ** N-->U
. generate NU_ind = tran == 7 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen NU_mr = wtmean(100 * NU_ind), weight(wtfinl)

. 
. ** N-->N
. generate NN_ind = tran == 9 & empstat_sp_broad == 3

. by year month empstat_sp_broad empstat_broad: egen NN_mr = wtmean(100 * NN_ind), weight(wtfinl)

. 
. drop UE_ind EU_ind EE_ind NE_ind EN_ind UN_ind NU_ind UU_ind NN_ind

. 
. drop wtfinl

. 
. foreach x of varlist EE_mr EU_mr EN_mr UE_mr UU_mr UN_mr NE_mr NU_mr NN_mr {   // rename all of the variables as the "spouse variable"
  2.         rename `x' `x'_N
  3. }

. *
. 
. 
. ** Change from zero to missing
. 
. foreach x of varlist EE_mr_E EU_mr_E EN_mr_E UE_mr_E UU_mr_E UN_mr_E NE_mr_E NU_mr_E NN_mr_E EE_mr_U EU_mr_U EN_mr_U UE_mr_U UU_mr_U UN_mr_U NE_mr_U NU_mr_U NN_mr_U EE_mr_N EU_mr_N EN_mr_N UE_mr_N UU_mr_N UN_mr_N
>  NE_mr_N NU_mr_N NN_mr_N  {  
  2.         replace `x'=. if `x'==0 
  3. }
(3,078,609 real changes made, 3,078,609 to missing)
(3,078,609 real changes made, 3,078,609 to missing)
(3,078,609 real changes made, 3,078,609 to missing)
(7,685,250 real changes made, 7,685,250 to missing)
(7,685,250 real changes made, 7,685,250 to missing)
(7,685,250 real changes made, 7,685,250 to missing)
(6,681,296 real changes made, 6,681,296 to missing)
(6,681,296 real changes made, 6,681,296 to missing)
(6,681,296 real changes made, 6,681,296 to missing)
(7,700,102 real changes made, 7,700,102 to missing)
(7,700,406 real changes made, 7,700,406 to missing)
(7,700,102 real changes made, 7,700,102 to missing)
(7,827,243 real changes made, 7,827,243 to missing)
(7,827,243 real changes made, 7,827,243 to missing)
(7,827,261 real changes made, 7,827,261 to missing)
(7,804,552 real changes made, 7,804,552 to missing)
(7,804,434 real changes made, 7,804,434 to missing)
(7,804,434 real changes made, 7,804,434 to missing)
(6,774,074 real changes made, 6,774,074 to missing)
(6,774,074 real changes made, 6,774,074 to missing)
(6,774,074 real changes made, 6,774,074 to missing)
(7,804,342 real changes made, 7,804,342 to missing)
(7,804,342 real changes made, 7,804,342 to missing)
(7,804,342 real changes made, 7,804,342 to missing)
(7,408,906 real changes made, 7,408,906 to missing)
(7,408,906 real changes made, 7,408,906 to missing)
(7,408,906 real changes made, 7,408,906 to missing)

. *
. 
. 
. collapse EE_mr_E EU_mr_E EN_mr_E UE_mr_E UU_mr_E UN_mr_E NE_mr_E NU_mr_E NN_mr_E EE_mr_U EU_mr_U EN_mr_U UE_mr_U UU_mr_U UN_mr_U NE_mr_U NU_mr_U NN_mr_U EE_mr_N EU_mr_N EN_mr_N UE_mr_N UU_mr_N UN_mr_N NE_mr_N NU_
> mr_N NN_mr_N, by( year month empstat_sp_broad empstat_broad )

. 
. 
. *** Graphs
. 
. ** generate the time variable
. gen time=ym(year ,month), after(month)

. 
. 
. ** Change label
. 
. foreach x of varlist EE_mr_E EU_mr_E EN_mr_E UE_mr_E UU_mr_E UN_mr_E NE_mr_E NU_mr_E NN_mr_E  {  
  2.    label var `x' "Partner Employed" 
  3.    }

. 
. *
. 
. foreach x of varlist EE_mr_U EU_mr_U EN_mr_U UE_mr_U UU_mr_U UN_mr_U NE_mr_U NU_mr_U NN_mr_U  {  
  2.   label var `x' "Partner Unemployed" 
  3.    }

. 
. *
. 
. foreach x of varlist EE_mr_N EU_mr_N EN_mr_N UE_mr_N UU_mr_N UN_mr_N NE_mr_N NU_mr_N NN_mr_N  {  
  2.    label var `x' "Partner Not in the labor force" 
  3.    }

. 
. *
. 
. 
. ** Plots
. 
. graph drop _all

. 
. tw line EE_mr_E EE_mr_U EE_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(EE) title("EE")

. graph export "$directory/Selection_07/EE.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/EE.png written in PNG format)

. 
. tw line EU_mr_E EU_mr_U EU_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(EU) title("EU")

. graph export "$directory/Selection_07/EU.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/EU.png written in PNG format)

. 
. tw line EN_mr_E EN_mr_U EN_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(EN) title("EN")

. graph export "$directory/Selection_07/EN.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/EN.png written in PNG format)

. 
. tw line UE_mr_E UE_mr_U UE_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(UE) title("UE")

. graph export "$directory/Selection_07/UE.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/UE.png written in PNG format)

. 
. tw line UU_mr_E UU_mr_U UU_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(UU) title("UU")

. graph export "$directory/Selection_07/UU.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/UU.png written in PNG format)

. 
. tw line UN_mr_E UN_mr_U UN_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(UN) title("UN")

. graph export "$directory/Selection_07/UN.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/UN.png written in PNG format)

. 
. tw line NE_mr_E NE_mr_U NE_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(NE) title("NE")

. graph export "$directory/Selection_07/NE.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/NE.png written in PNG format)

. 
. tw line NU_mr_E NU_mr_U NU_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(NU) title("NU")

. graph export "$directory/Selection_07/NU.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/NU.png written in PNG format)

. 
. tw line NN_mr_E NN_mr_U NN_mr_N time , xtick(407.5(12)695.5, tlength(*1.5)) xlabel(425.5(24)689.5, noticks format(%tmYY))  xtitle("") name(NN) title("NN")

. graph export "$directory/Selection_07/NN.png" , replace
(file /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07/NN.png written in PNG format)

. 
. 
. 
. 
. ** Manipulates the final aggregate dataset
. drop time empstat_broad empstat_sp_broad

. collapse EE_mr_E EU_mr_E EN_mr_E UE_mr_E UU_mr_E UN_mr_E NE_mr_E NU_mr_E NN_mr_E EE_mr_U EU_mr_U EN_mr_U UE_mr_U UU_mr_U UN_mr_U NE_mr_U NU_mr_U NN_mr_U EE_mr_N EU_mr_N EN_mr_N UE_mr_N UU_mr_N UN_mr_N NE_mr_N NU_
> mr_N NN_mr_N, by ( year month )

. 
. 
. 
. ** Change label
. 
. foreach x of varlist EE_mr_E EU_mr_E EN_mr_E UE_mr_E UU_mr_E UN_mr_E NE_mr_E NU_mr_E NN_mr_E  {  
  2.    label var `x' "Partner Employed" 
  3.    }

. 
. *
. 
. foreach x of varlist EE_mr_U EU_mr_U EN_mr_U UE_mr_U UU_mr_U UN_mr_U NE_mr_U NU_mr_U NN_mr_U  {  
  2.   label var `x' "Partner Unemployed" 
  3.    }

. 
. *
. 
. foreach x of varlist EE_mr_N EU_mr_N EN_mr_N UE_mr_N UU_mr_N UN_mr_N NE_mr_N NU_mr_N NN_mr_N  {  
  2.    label var `x' "Partner Not in the labor force" 
  3.    }

. *
. 
. 
. 
. 
. 
. cd "$directory/Selection_07"
/Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_07

. 
. save "Partn_status_flows.dta", replace
file Partn_status_flows.dta saved

. 
. 
. cd "$directory/Selection_05"
/Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_05

. 
. log close main_06
      name:  main_06
       log:  /Users/tommaso/Desktop/RAship_Javier/IPUMS/Selection_05/main_06.log
  log type:  text
 closed on:  13 Jan 2018, 16:44:38
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
